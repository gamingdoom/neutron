#!/bin/bash

export MOZBUILD_STATE_PATH=$PWD/.mozbuild
export PATH="$PATH:$mozbuild/git-cinnabar"

rustup target add x86_64-apple-darwin

mozilla-unified/mach artifact toolchain --from-build linux64-clang
mozilla-unified/mach artifact toolchain --from-build linux64-sccache
mozilla-unified/mach artifact toolchain --from-build sysroot-wasm32-wasi

pushd $MOZBUILD_STATE_PATH
    wget https://github.com/joseluisq/macosx-sdks/releases/download/26.1/MacOSX26.1.sdk.tar.xz -O MacOSX26.1.sdk.tar.xz
    tar xf MacOSX26.1.sdk.tar.xz
popd

cd mozilla-unified

cp -r ../src/changed/* .
cp ../src/mozconfig.mac-intel mozconfig

./mach configure --with-macos-sdk=$MOZBUILD_STATE_PATH/MacOSX26.1.sdk
./mach build
./mach package

cd ..

rm -rf NEUTRON_INTERNAL_APP_NAME-darwin-x86_64
mkdir NEUTRON_INTERNAL_APP_NAME-darwin-x86_64

cp -r mozilla-unified/obj-x86_64-apple-darwin/dist/NEUTRON_INTERNAL_APP_NAME/*.app/* NEUTRON_INTERNAL_APP_NAME-darwin-x86_64/

cp -r src/distribution/ NEUTRON_INTERNAL_APP_NAME-darwin-x86_64/Contents/Resources/
mv NEUTRON_INTERNAL_APP_NAME-darwin-x86_64/Contents/Resources/distribution/policies-linux.json NEUTRON_INTERNAL_APP_NAME-darwin-x86_64/Contents/Resources/distribution/policies.json

cp src/open-in-default-browser/open-in-default-browser-mac NEUTRON_INTERNAL_APP_NAME-darwin-x86_64/Contents/Resources/open-in-default-browser
cp src/open-in-default-browser/open-in-default-browser-mac NEUTRON_INTERNAL_APP_NAME-darwin-x86_64/Contents/MacOS/open-in-default-browser

cp src/changed/browser/branding/NEUTRON_INTERNAL_APP_NAME/firefox.icns NEUTRON_INTERNAL_APP_NAME-darwin-x86_64/Contents/Resources/firefox.icns

cp -f src/mac/Info-x86_64.plist NEUTRON_INTERNAL_APP_NAME-darwin-x86_64/Contents/Info.plist
