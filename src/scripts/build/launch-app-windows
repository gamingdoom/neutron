#!/bin/bash

moz_include=${PWD}/mozilla-unified/obj-x86_64-pc-mingw32/dist/include
xul_lib=${PWD}/work/NEUTRON_INTERNAL_APP_NAME/xul.dll

pushd src/windows
	x86_64-w64-mingw32-windres app.rc -O coff -o app.res
popd

rm -rf src/launch-app/build
mkdir src/launch-app/build
pushd src/launch-app/build
	cmake \
		-DCMAKE_SYSTEM_NAME=Windows \
		-DCMAKE_CXX_FLAGS="-Wno-cast-function-type -static -static-libgcc -static-libstdc++ -mwindows" \
		-DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
		-DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ \
		.. \
		-DAPPLICATION_NAME=\"NEUTRON_INTERNAL_APP_NAME.exe\" \
		-DSHOULD_OPEN_IN_DEFAULT_BROWSER=NEUTRON_OPEN_IN_DEFAULT_BROWSER \
		-DSHOULD_RUN_IN_BACKGROUND=NEUTRON_SHOULD_RUN_IN_BACKGROUND \
		-DRES_PATH="../../windows/app.res" \
		-D_WINDOWS= \
		-DWIN32= \
		-DBOOST_IOSTREAMS_ENABLE_ZSTD=false \
		-DMOZILLA_INCLUDE_DIR="${moz_include}" \
		-DXUL_LIBRARY="${xul_lib}"

	make -j
	cp launch-app.exe ../../launch-app.windows
popd

pushd work
cp ../src/launch-app.windows NEUTRON_INTERNAL_APP_NAME/launch-NEUTRON_INTERNAL_APP_NAME.exe
popd