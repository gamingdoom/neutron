#!/bin/bash

export MOZBUILD_STATE_PATH=$PWD/.mozbuild

if [ ! -d mozilla-unified ]; then
	curl https://hg.mozilla.org/mozilla-central/raw-file/default/python/mozboot/bin/bootstrap.py -LO
	python3 bootstrap.py --vcs=git --no-interactive --application-choice=browser_artifact_mode

	# they renamed mozilla-unified to firefox, so we need to fix that
	mv firefox mozilla-unified

	cd mozilla-unified
	git checkout $(git tag | grep -E "^FIREFOX_[0-9]*_[0-9]*(_[0-9]*)?_RELEASE" | sort -V | tail -n1)

	echo "Applying universal patches"
	for patch in ../src/patches/*.patch; do
		patch -p1 < $patch
	done
	echo "Done applying universal patches"

	cd ..
fi