#!/bin/bash

shopt -s extglob

export MOZBUILD_STATE_PATH=$PWD/.mozbuild
export PATH="$PATH:$mozbuild/git-cinnabar"

cd mozilla-unified

cp -r ../src/changed/* .
cp ../src/mozconfig.linux mozconfig

./mach --no-interactive bootstrap --application-choice "Firefox for Desktop"
./mach configure
./mach build
./mach package

cd ..

rm -r NEUTRON_INTERNAL_APP_NAME-linux-x86_64
mkdir NEUTRON_INTERNAL_APP_NAME-linux-x86_64
tar --strip-components=1 -xvf  mozilla-unified/obj-x86_64-pc-linux-gnu/dist/*.tar.@(bz2|xz) -C NEUTRON_INTERNAL_APP_NAME-linux-x86_64/
cp -r src/distribution/ NEUTRON_INTERNAL_APP_NAME-linux-x86_64/
mv NEUTRON_INTERNAL_APP_NAME-linux-x86_64/distribution/policies-linux.json NEUTRON_INTERNAL_APP_NAME-linux-x86_64/distribution/policies.json
cp src/open-in-default-browser/open-in-default-browser NEUTRON_INTERNAL_APP_NAME-linux-x86_64/open-in-default-browser
